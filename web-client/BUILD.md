# Web Client Build System

## Overview

The web client now uses **webpack** instead of react-scripts for better control over the build process and compatibility with modern TypeScript and protobuf code generation.

## Technology Stack

- **React 18.3+** - UI framework
- **TypeScript 5.3+** - Type-safe development
- **Webpack 5** - Module bundler
- **Connect-RPC** - gRPC-Web client libraries (formerly @bufbuild/connect)
- **Buf** - Protocol buffer toolchain

## Key Changes from Original Setup

### 1. Dependencies Updated

**Replaced:**
- `@bufbuild/connect` → `@connectrpc/connect`
- `@bufbuild/connect-web` → `@connectrpc/connect-web`
- `@bufbuild/protoc-gen-connect-es` → `@connectrpc/protoc-gen-connect-es`
- `react-scripts` → Custom webpack configuration

**Added:**
- `webpack`, `webpack-cli`, `webpack-dev-server`
- `ts-loader` for TypeScript compilation
- `html-webpack-plugin` for HTML generation
- `css-loader`, `style-loader` for CSS processing
- `copy-webpack-plugin` for static assets

### 2. Webpack Configuration

**File: `webpack.config.js`**

Key features:
- TypeScript compilation via `ts-loader`
- CSS module support
- Development server with hot reload on port 3000
- Production builds with code splitting and minification
- Proxy configuration for `/api` requests to nginx (port 8080)
- **Extension alias** to handle `.js` imports in generated protobuf code

### 3. Protobuf Generation

**Updated `buf.gen.yaml`:**
```yaml
version: v2
plugins:
  - local: protoc-gen-es
    out: src/gen
    opt: target=ts
  - local: protoc-gen-connect-es
    out: src/gen
    opt: target=ts
```

Uses local plugins installed via npm instead of remote plugins.

### 4. Build Commands

```bash
# Development
npm start              # Webpack dev server on http://localhost:3000
make dev-web-client    # Same as above, via makefile

# Production
npm run build          # Generates protobuf types and builds with webpack
make build-web-client  # Same as above, via makefile

# Protobuf generation only
npm run proto          # Generate TypeScript types from .proto files

# Testing
make test-web-client   # Verify setup, dependencies, and build
```

### 5. Build Output

Production build creates:
```
build/
├── index.html                    # Main HTML file
├── main.[contenthash].js         # Bundled application code
├── main.[contenthash].js.map     # Source map for debugging
└── main.[contenthash].js.LICENSE.txt  # Third-party licenses
```

## Docker Integration

**Updated `Dockerfile.web`:**

- Multi-stage build
- Stage 1: Build React app with webpack
- Stage 2: Serve with nginx
- Includes protobuf generation in build process
- Properly copies all required config files (`webpack.config.js`, `buf.yaml`, etc.)

## Common Issues & Solutions

### Issue: "Module not found: Can't resolve './example-service_pb.js'"

**Solution:** Added `extensionAlias` to webpack config:
```javascript
resolve: {
  extensionAlias: {
    '.js': ['.ts', '.tsx', '.js', '.jsx'],
  }
}
```

This allows webpack to resolve `.js` imports to `.ts` files generated by protoc.

### Issue: Package version conflicts

**Solution:** Updated to latest stable versions:
- Use `@connectrpc/*` packages instead of deprecated `@bufbuild/connect*`
- Use `@connectrpc/protoc-gen-connect-es` plugin
- Updated to TypeScript 5.3+ and React 18.3+

### Issue: Buf remote plugins not found

**Solution:** Changed from remote to local plugins in `buf.gen.yaml`:
- `remote: buf.build/protocolbuffers/es` → `local: protoc-gen-es`
- `remote: buf.build/connectrpc/es` → `local: protoc-gen-connect-es`

## Development Workflow

1. **Start backend services:**
   ```bash
   make up  # Starts PostgreSQL, Redis, NATS, example-service, nginx
   ```

2. **Start React dev server:**
   ```bash
   make dev-web-client  # or: cd web-client && npm start
   ```

3. **Make changes:**
   - Edit React components in `src/`
   - Hot reload automatically updates browser
   - API calls proxy through nginx to gRPC service

4. **Update protobuf definitions:**
   ```bash
   # Edit services/example-service/proto/example-service.proto
   cd web-client
   npm run proto  # Regenerate TypeScript types
   ```

## Production Deployment

```bash
# Build web client
make build-web-client

# Build Docker image
make docker-build-web

# Or build everything with docker-compose
make up  # Includes building web-client service
```

## File Structure

```
web-client/
├── package.json              # Dependencies and scripts
├── webpack.config.js         # Webpack configuration
├── tsconfig.json            # TypeScript configuration
├── buf.yaml                 # Buf workspace config
├── buf.gen.yaml             # Protobuf generation config
├── public/
│   └── index.html           # HTML template
├── src/
│   ├── index.tsx            # Entry point
│   ├── App.tsx              # Main component
│   ├── index.css            # Styles
│   └── gen/                 # Generated protobuf types
│       ├── example-service_pb.ts
│       └── example-service_connect.ts
└── build/                   # Production build output
```

## Testing

Run the comprehensive test:
```bash
make test-web-client
```

This verifies:
- Node.js and npm are installed (v18+)
- Dependencies install correctly
- Protobuf generation works
- Webpack build succeeds
- Build artifacts are created

## Next Steps

To add new RPC methods:

1. Update `services/example-service/proto/example-service.proto`
2. Rebuild protobuf for Go service: `make proto SERVICE=example-service`
3. Regenerate TypeScript types: `cd web-client && npm run proto`
4. Update `src/App.tsx` to call new methods
5. Test in development mode: `npm start`
6. Build for production: `npm run build`